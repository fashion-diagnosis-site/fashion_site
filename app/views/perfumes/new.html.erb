<%# ---------- エラーメッセージ ---------- %>
<% if @perfume.errors.any? %>
  <div class="fx-quiz-alert">
    <strong>入力にエラーがあります。</strong>
    <ul>
      <% @perfume.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<div class="fx-quiz-canvas">
  <header class="fx-quiz-hero">
    <div class="fx-quiz-hero-inner">
      <div>
        <h1 class="fx-quiz-title">コーデ診断</h1>
        <p class="fx-quiz-sub">直感で選んでください（全9問）</p>
      </div>
      <div class="fx-quiz-hero-badge">
        <span>あなたのスタイルを診断中…</span>
        <span>Dresscode:You</span>
      </div>
    </div>

    <div class="fx-quiz-progress">
      <div class="fx-quiz-progress-top">
        <span class="fx-quiz-progress-label">QUESTION</span>
        <span class="fx-quiz-progress-tag"><span class="fx-quiz-progress-current">1</span> / 9</span>
      </div>
      <div class="fx-quiz-progress-bar">
        <div class="fx-quiz-progress-fill"></div>
      </div>
    </div>
  </header>

  <%= form_for(@perfume, class: 'fx-quiz-form', role: 'form') do |f| %>

    <div class="fx-quiz-main">
      <%# 左側：質問ブロック（1問ずつ中央） %>
      <div class="fx-quiz-steps">
        <%# ========== Q1 ========== %>
        <fieldset class="fx-quiz-block is-active" data-quiz-step="1">
          <legend class="fx-quiz-q">Q1. トレンドアイテムは？</legend>
          <div class="fx-quiz-options">
            <input type="radio" name="perfume[question1]" id="q1a" value="A" required>
            <label class="fx-quiz-option" for="q1a">取り入れたい</label>

            <input type="radio" name="perfume[question1]" id="q1b" value="B">
            <label class="fx-quiz-option" for="q1b">気にしない</label>
          </div>
        </fieldset>

        <%# ========== Q2 ========== %>
        <fieldset class="fx-quiz-block" data-quiz-step="2">
          <legend class="fx-quiz-q">Q2. どっち派？</legend>
          <div class="fx-quiz-options">
            <input type="radio" name="perfume[question2]" id="q2a" value="A" required>
            <label class="fx-quiz-option" for="q2a">アウトドア</label>

            <input type="radio" name="perfume[question2]" id="q2b" value="B">
            <label class="fx-quiz-option" for="q2b">インドア</label>
          </div>
        </fieldset>

        <%# ========== Q3 ========== %>
        <fieldset class="fx-quiz-block" data-quiz-step="3">
          <legend class="fx-quiz-q">Q3. 靴はどっちをはくことが多い？</legend>
          <div class="fx-quiz-options">
            <input type="radio" name="perfume[question3]" id="q3a" value="A" required>
            <label class="fx-quiz-option" for="q3a">スニーカー（派手め）、サンダル系</label>

            <input type="radio" name="perfume[question3]" id="q3b" value="B">
            <label class="fx-quiz-option" for="q3b">スニーカー（シンプル）、革靴系</label>
          </div>
        </fieldset>

        <%# ========== Q4 ========== %>
        <fieldset class="fx-quiz-block" data-quiz-step="4">
          <legend class="fx-quiz-q">Q4. ショッピングで最も重視するポイントは？</legend>
          <div class="fx-quiz-options">
            <input type="radio" name="perfume[question4]" id="q4a" value="A" required>
            <label class="fx-quiz-option" for="q4a">デザイン</label>

            <input type="radio" name="perfume[question4]" id="q4b" value="B">
            <label class="fx-quiz-option" for="q4b">着心地</label>

            <input type="radio" name="perfume[question4]" id="q4c" value="C">
            <label class="fx-quiz-option" for="q4c">価格</label>

            <input type="radio" name="perfume[question4]" id="q4d" value="D">
            <label class="fx-quiz-option" for="q4d">流行</label>
          </div>
        </fieldset>

        <%# ========== Q5 ========== %>
        <fieldset class="fx-quiz-block" data-quiz-step="5">
          <legend class="fx-quiz-q">Q5. 憧れるのはどっちのスタイル？</legend>
          <div class="fx-quiz-options">
            <input type="radio" name="perfume[question5]" id="q5a" value="A" required>
            <label class="fx-quiz-option" for="q5a">町で浮かない落ち着いた雰囲気</label>

            <input type="radio" name="perfume[question5]" id="q5b" value="B">
            <label class="fx-quiz-option" for="q5b">個性が出るファッション</label>
          </div>
        </fieldset>

        <%# ========== Q6 ========== %>
        <fieldset class="fx-quiz-block" data-quiz-step="6">
          <legend class="fx-quiz-q">Q6. 色遣いはどっち派？</legend>
          <div class="fx-quiz-options">
            <input type="radio" name="perfume[question6]" id="q6a" value="A" required>
            <label class="fx-quiz-option" for="q6a">モノトーンやアースカラー中心</label>

            <input type="radio" name="perfume[question6]" id="q6b" value="B">
            <label class="fx-quiz-option" for="q6b">指し色や派手目なカラーが好き</label>
          </div>
        </fieldset>

        <%# ========== Q7 ========== %>
        <fieldset class="fx-quiz-block" data-quiz-step="7">
          <legend class="fx-quiz-q">Q7. 素材を選ぶなら？</legend>
          <div class="fx-quiz-options">
            <input type="radio" name="perfume[question7]" id="q7a" value="A" required>
            <label class="fx-quiz-option" for="q7a">ナイロン・機能素材系</label>

            <input type="radio" name="perfume[question7]" id="q7b" value="B">
            <label class="fx-quiz-option" for="q7b">コットン・デニム・レザーなど</label>
          </div>
        </fieldset>

        <%# ========== Q8 ========== %>
        <fieldset class="fx-quiz-block" data-quiz-step="8">
          <legend class="fx-quiz-q">Q8. 服を選ぶモチベーションは？</legend>
          <div class="fx-quiz-options">
            <input type="radio" name="perfume[question8]" id="q8a" value="A" required>
            <label class="fx-quiz-option" for="q8a">実用性</label>

            <input type="radio" name="perfume[question8]" id="q8b" value="B">
            <label class="fx-quiz-option" for="q8b">おしゃれ</label>

            <input type="radio" name="perfume[question8]" id="q8c" value="C">
            <label class="fx-quiz-option" for="q8c">クラシック</label>

            <input type="radio" name="perfume[question8]" id="q8d" value="D">
            <label class="fx-quiz-option" for="q8d">スポーティ</label>
          </div>
        </fieldset>

        <%# ========== Q9 ========== %>
        <fieldset class="fx-quiz-block" data-quiz-step="9">
          <legend class="fx-quiz-q">Q9. よく言われる印象は？</legend>
          <div class="fx-quiz-options">
            <input type="radio" name="perfume[question9]" id="q9a" value="A" required>
            <label class="fx-quiz-option" for="q9a">元気</label>

            <input type="radio" name="perfume[question9]" id="q9b" value="B">
            <label class="fx-quiz-option" for="q9b">落ち着いている</label>

            <input type="radio" name="perfume[question9]" id="q9c" value="C">
            <label class="fx-quiz-option" for="q9c">面白い</label>

            <input type="radio" name="perfume[question9]" id="q9d" value="D">
            <label class="fx-quiz-option" for="q9d">優しい</label>
          </div>
        </fieldset>
      </div>

      <%# 右側：縦方向に進んでいくステップインジケーター %>
      <aside class="fx-quiz-stepper">
        <ol class="fx-quiz-stepper-list">
          <% (1..9).each do |i| %>
            <li class="fx-quiz-stepper-item <%= 'is-current' if i == 1 %>" data-quiz-step="<%= i %>">
              <span class="fx-quiz-stepper-dot"></span>
              <span class="fx-quiz-stepper-label">Q<%= i %></span>
            </li>
          <% end %>
        </ol>
      </aside>
    </div>

    <div class="fx-quiz-submit">
      <%= f.submit " 診断する ", class: "fx-quiz-btn fx-quiz-btn-primary" %>
    </div>
  <% end %>
</div>

<%# ========= JS：選択したら自動で次のQへ（縦ステップが下に進む） ========= %>
<script>
  function fxQuizSetup() {
    const blocks = Array.from(document.querySelectorAll('.fx-quiz-block'));
    if (!blocks.length) return;

    const stepperItems = Array.from(document.querySelectorAll('.fx-quiz-stepper-item'));
    const progressFill = document.querySelector('.fx-quiz-progress-fill');
    const progressCurrent = document.querySelector('.fx-quiz-progress-current');
    const submitBtn = document.querySelector('.fx-quiz-btn-primary');
    const total = blocks.length;

    let currentIndex = 0;

    function updateUI() {
      blocks.forEach((b, idx) => {
        b.classList.toggle('is-active', idx === currentIndex);
      });

      stepperItems.forEach((item, idx) => {
        item.classList.toggle('is-current', idx === currentIndex);
        item.classList.toggle('is-past', idx < currentIndex);
      });

      if (progressCurrent) progressCurrent.textContent = (currentIndex + 1);
      if (progressFill) {
        const percent = ((currentIndex + 1) / total) * 100;
        progressFill.style.width = percent + '%';
      }
    }

    function goNext() {
      if (currentIndex < total - 1) {
        currentIndex += 1;
        updateUI();
      } else {
        if (submitBtn) {
          submitBtn.classList.add('is-pulse');
          setTimeout(() => submitBtn.classList.remove('is-pulse'), 800);
        }
      }
    }

    blocks.forEach((block) => {
      const radios = block.querySelectorAll('input[type="radio"]');
      radios.forEach((r) => {
        r.addEventListener('change', () => {
          const idx = blocks.indexOf(block);
          if (idx === currentIndex) {
            goNext();
          }
        });
      });
    });

    updateUI();
  }

  document.addEventListener('turbo:load', fxQuizSetup);
  document.addEventListener('DOMContentLoaded', fxQuizSetup);
</script>